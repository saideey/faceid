{% extends "base.html" %}

{% block title %}Bonuslar - Davomat Tizimi{% endblock %}
{% block page_title %}Bonuslar{% endblock %}
{% block page_subtitle %}Bonuslarni boshqarish va avtomatik hisoblash{% endblock %}

{% block content %}
<!-- Quick Actions -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <button onclick="openAddBonusModal()" class="stat-card p-6 hover:shadow-lg transition-all cursor-pointer">
        <div class="flex items-center justify-between mb-3">
            <i class="fas fa-gift text-4xl text-blue-600"></i>
            <i class="fas fa-plus text-2xl text-gray-400"></i>
        </div>
        <h3 class="font-semibold text-gray-800">Qo'lda bonus berish</h3>
        <p class="text-sm text-gray-500 mt-1">Xodimga manual bonus qo'shish</p>
    </button>
    
    <button onclick="openPerfectAttendanceModal()" class="stat-card p-6 hover:shadow-lg transition-all cursor-pointer">
        <div class="flex items-center justify-between mb-3">
            <i class="fas fa-star text-4xl text-yellow-500"></i>
            <i class="fas fa-magic text-2xl text-gray-400"></i>
        </div>
        <h3 class="font-semibold text-gray-800">Mukammal davomat</h3>
        <p class="text-sm text-gray-500 mt-1">Avtomatik hisoblash</p>
    </button>
    
    <button onclick="openEarlyArrivalModal()" class="stat-card p-6 hover:shadow-lg transition-all cursor-pointer">
        <div class="flex items-center justify-between mb-3">
            <i class="fas fa-clock text-4xl text-green-600"></i>
            <i class="fas fa-magic text-2xl text-gray-400"></i>
        </div>
        <h3 class="font-semibold text-gray-800">Erta kelish</h3>
        <p class="text-sm text-gray-500 mt-1">Avtomatik hisoblash</p>
    </button>
</div>

<!-- Filters -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="searchInput" placeholder="Xodim qidirish..." 
                class="form-input pl-10">
        </div>
        
        <input type="date" id="startDate" class="form-input">
        <input type="date" id="endDate" class="form-input">
        
        <select id="bonusTypeFilter" class="form-input">
            <option value="">Barcha turlar</option>
            <option value="perfect_attendance">Mukammal davomat</option>
            <option value="early_arrival">Erta kelish</option>
            <option value="overtime">Qo'shimcha ish</option>
            <option value="manual">Qo'lda</option>
        </select>
        
        <select id="employeeFilter" class="form-input">
            <option value="">Barcha xodimlar</option>
        </select>
    </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="stat-card p-6 bg-gradient-to-br from-green-500 to-green-600 text-white">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium opacity-90">Jami bonuslar</h3>
            <i class="fas fa-gift text-2xl opacity-50"></i>
        </div>
        <p class="text-3xl font-bold mb-1" id="totalBonuses">0</p>
        <p class="text-xs opacity-75" id="totalBonusAmount">0 so'm</p>
    </div>
    
    <div class="stat-card p-6 bg-gradient-to-br from-yellow-500 to-yellow-600 text-white">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium opacity-90">Mukammal davomat</h3>
            <i class="fas fa-star text-2xl opacity-50"></i>
        </div>
        <p class="text-3xl font-bold mb-1" id="perfectBonuses">0</p>
        <p class="text-xs opacity-75" id="perfectBonusAmount">0 so'm</p>
    </div>
    
    <div class="stat-card p-6 bg-gradient-to-br from-blue-500 to-blue-600 text-white">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium opacity-90">Erta kelish</h3>
            <i class="fas fa-clock text-2xl opacity-50"></i>
        </div>
        <p class="text-3xl font-bold mb-1" id="earlyBonuses">0</p>
        <p class="text-xs opacity-75" id="earlyBonusAmount">0 so'm</p>
    </div>
    
    <div class="stat-card p-6 bg-gradient-to-br from-purple-500 to-purple-600 text-white">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium opacity-90">Qo'lda</h3>
            <i class="fas fa-hand-holding-usd text-2xl opacity-50"></i>
        </div>
        <p class="text-3xl font-bold mb-1" id="manualBonuses">0</p>
        <p class="text-xs opacity-75" id="manualBonusAmount">0 so'm</p>
    </div>
</div>

<!-- Tabs -->
<div class="bg-white rounded-t-xl border-b border-gray-200">
    <div class="flex space-x-1 p-2">
        <button onclick="switchTab('bonuses')" id="bonusesTab" 
            class="tab-button px-6 py-3 rounded-lg font-medium transition active">
            <i class="fas fa-list mr-2"></i>
            Bonuslar ro'yxati
        </button>
        <button onclick="switchTab('leaderboard')" id="leaderboardTab" 
            class="tab-button px-6 py-3 rounded-lg font-medium transition">
            <i class="fas fa-trophy mr-2"></i>
            Liderlar
        </button>
    </div>
</div>

<!-- Bonuses List Tab -->
<div id="bonusesContent" class="tab-content">
    <div class="table-container border-t-0 rounded-t-none">
        <table>
            <thead>
                <tr>
                    <th>Xodim</th>
                    <th>Sana</th>
                    <th>Tur</th>
                    <th>Summa</th>
                    <th>Sabab</th>
                    <th>Kim berdi</th>
                    <th>Harakatlar</th>
                </tr>
            </thead>
            <tbody id="bonusesTableBody">
                <!-- Filled by JS -->
            </tbody>
        </table>
        
        <!-- Empty State -->
        <div id="emptyState" class="hidden py-16 text-center">
            <i class="fas fa-gift text-gray-300 text-6xl mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Bonuslar topilmadi</h3>
            <p class="text-gray-500">Yuqoridagi tugmalardan foydalanib bonus qo'shing</p>
        </div>
    </div>
</div>

<!-- Leaderboard Tab -->
<div id="leaderboardContent" class="tab-content hidden">
    <div class="bg-white rounded-b-xl shadow-sm border border-gray-200 border-t-0">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">Top xodimlar</h3>
                    <p class="text-sm text-gray-500 mt-1">Eng ko'p bonus olganlar</p>
                </div>
                <div class="flex gap-3">
                    <input type="date" id="leaderboardStart" class="form-input">
                    <input type="date" id="leaderboardEnd" class="form-input">
                    <button onclick="loadLeaderboard()" class="btn-primary">
                        <i class="fas fa-sync mr-2"></i>
                        Yangilash
                    </button>
                </div>
            </div>
        </div>
        
        <div class="p-8">
            <!-- Top 3 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div id="rank2" class="order-2 md:order-1">
                    <!-- Filled by JS -->
                </div>
                <div id="rank1" class="order-1 md:order-2">
                    <!-- Filled by JS -->
                </div>
                <div id="rank3" class="order-3">
                    <!-- Filled by JS -->
                </div>
            </div>
            
            <!-- Rest of leaderboard -->
            <div class="space-y-3" id="leaderboardList">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="flex items-center justify-between mt-6">
    <div class="text-sm text-gray-600">
        Ko'rsatilmoqda: <span id="showingCount">0</span> / <span id="totalCount">0</span>
    </div>
    <div class="flex gap-2" id="paginationContainer">
        <!-- Filled by JS -->
    </div>
</div>

<!-- Add Manual Bonus Modal -->
<div id="addBonusModal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4">
        <div class="border-b border-gray-200 px-8 py-6">
            <h2 class="text-2xl font-bold text-gray-800">Bonus berish</h2>
            <p class="text-sm text-gray-500 mt-1">Xodimga qo'lda bonus qo'shish</p>
        </div>
        
        <form id="addBonusForm" class="p-8">
            <div class="space-y-6">
                <div>
                    <label class="form-label">Xodimlar <span class="text-red-500">*</span></label>
                    <select id="bonusEmployeeId" multiple class="form-input h-32">
                        <!-- Filled by JS -->
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Ctrl tugmasini bosib bir nechta xodim tanlang</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Summa (UZS) <span class="text-red-500">*</span></label>
                        <input type="number" id="bonusAmount" required class="form-input" 
                            placeholder="100000" step="10000">
                    </div>
                    
                    <div>
                        <label class="form-label">Sana <span class="text-red-500">*</span></label>
                        <input type="date" id="bonusDate" required class="form-input">
                    </div>
                </div>
                
                <div>
                    <label class="form-label">Sabab <span class="text-red-500">*</span></label>
                    <textarea id="bonusReason" required class="form-input" rows="3" 
                        placeholder="Bonus sababi..."></textarea>
                </div>
            </div>
            
            <div class="flex items-center justify-end gap-3 mt-8">
                <button type="button" onclick="closeAddBonusModal()" class="btn-secondary">
                    Bekor qilish
                </button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save mr-2"></i>
                    Berish
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Perfect Attendance Modal -->
<div id="perfectAttendanceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4">
        <div class="border-b border-gray-200 px-8 py-6">
            <h2 class="text-2xl font-bold text-gray-800">Mukammal davomat bonusi</h2>
            <p class="text-sm text-gray-500 mt-1">Avtomatik hisoblash</p>
        </div>
        
        <form id="perfectAttendanceForm" class="p-8">
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Oy <span class="text-red-500">*</span></label>
                        <select id="perfectMonth" required class="form-input">
                            <option value="1">Yanvar</option>
                            <option value="2">Fevral</option>
                            <option value="3">Mart</option>
                            <option value="4">Aprel</option>
                            <option value="5">May</option>
                            <option value="6">Iyun</option>
                            <option value="7">Iyul</option>
                            <option value="8">Avgust</option>
                            <option value="9">Sentabr</option>
                            <option value="10">Oktabr</option>
                            <option value="11">Noyabr</option>
                            <option value="12">Dekabr</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="form-label">Yil <span class="text-red-500">*</span></label>
                        <input type="number" id="perfectYear" required class="form-input" 
                            value="2025" min="2020" max="2030">
                    </div>
                </div>
                
                <div>
                    <label class="form-label">Bonus miqdori (UZS) <span class="text-red-500">*</span></label>
                    <input type="number" id="perfectAmount" required class="form-input" 
                        placeholder="200000" step="10000" value="200000">
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-blue-800 mb-1">Shartlar</p>
                            <ul class="text-xs text-blue-700 space-y-1">
                                <li>âœ“ Bir marta ham kech qolmagan</li>
                                <li>âœ“ Bir marta ham erta ketmagan</li>
                                <li>âœ“ Barcha ish kunlarida qatnashgan</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-end gap-3 mt-8">
                <button type="button" onclick="closePerfectAttendanceModal()" class="btn-secondary">
                    Bekor qilish
                </button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-calculator mr-2"></i>
                    Hisoblash
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Early Arrival Modal -->
<div id="earlyArrivalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4">
        <div class="border-b border-gray-200 px-8 py-6">
            <h2 class="text-2xl font-bold text-gray-800">Erta kelish bonusi</h2>
            <p class="text-sm text-gray-500 mt-1">Avtomatik hisoblash</p>
        </div>
        
        <form id="earlyArrivalForm" class="p-8">
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Boshlanish <span class="text-red-500">*</span></label>
                        <input type="date" id="earlyStartDate" required class="form-input">
                    </div>
                    
                    <div>
                        <label class="form-label">Tugash <span class="text-red-500">*</span></label>
                        <input type="date" id="earlyEndDate" required class="form-input">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Kamida necha daqiqa erta</label>
                        <input type="number" id="earlyMinutes" class="form-input" 
                            value="15" min="1" max="60">
                    </div>
                    
                    <div>
                        <label class="form-label">Kamida necha kun</label>
                        <input type="number" id="earlyMinDays" class="form-input" 
                            value="10" min="1" max="31">
                    </div>
                </div>
                
                <div>
                    <label class="form-label">Bonus miqdori (UZS) <span class="text-red-500">*</span></label>
                    <input type="number" id="earlyAmount" required class="form-input" 
                        placeholder="100000" step="10000" value="100000">
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-green-600 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-green-800 mb-1">Shartlar</p>
                            <p class="text-xs text-green-700">Tanlangan davrda kamida <strong id="earlyMinDaysPreview">10</strong> kun, har safar kamida <strong id="earlyMinutesPreview">15</strong> daqiqa erta kelgan xodimlar bonusga loyiq.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-end gap-3 mt-8">
                <button type="button" onclick="closeEarlyArrivalModal()" class="btn-secondary">
                    Bekor qilish
                </button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-calculator mr-2"></i>
                    Hisoblash
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.tab-button {
    color: #64748b;
}

.tab-button.active {
    background: #2563eb;
    color: white;
}

.tab-button:not(.active):hover {
    background: #f1f5f9;
}
</style>

{% endblock %}

{% block extra_js %}
<script>
let bonuses = [];
let employees = [];
let currentPage = 1;
let perPage = 20;

// Load bonuses
async function loadBonuses() {
    showLoading();
    
    try {
        const filters = {
            page: currentPage,
            per_page: perPage
        };
        
        const search = document.getElementById('searchInput').value;
        if (search) filters.search = search;
        
        const startDate = document.getElementById('startDate').value;
        if (startDate) filters.start_date = startDate;
        
        const endDate = document.getElementById('endDate').value;
        if (endDate) filters.end_date = endDate;
        
        const bonusType = document.getElementById('bonusTypeFilter').value;
        if (bonusType) filters.bonus_type = bonusType;
        
        const employeeId = document.getElementById('employeeFilter').value;
        if (employeeId) filters.employee_id = employeeId;
        
        const response = await API.bonuses.list(filters);
        bonuses = response.bonuses || [];
        
        renderBonusesTable();
        updateStats();
        renderPagination(response.pagination);
        
    } catch (error) {
        console.error('Error loading bonuses:', error);
        showNotification('Bonuslarni yuklashda xatolik', 'error');
    } finally {
        hideLoading();
    }
}

// Load employees
async function loadEmployees() {
    try {
        const response = await API.employees.list({ per_page: 1000, status: 'active' });
        employees = response.employees || [];
        
        const employeeFilter = document.getElementById('employeeFilter');
        const bonusEmployeeSelect = document.getElementById('bonusEmployeeId');
        
        const options = employees.map(e => 
            `<option value="${e.id}">${e.full_name} (${e.employee_no})</option>`
        ).join('');
        
        employeeFilter.innerHTML = '<option value="">Barcha xodimlar</option>' + options;
        bonusEmployeeSelect.innerHTML = options;
        
    } catch (error) {
        console.error('Error loading employees:', error);
    }
}

function renderBonusesTable() {
    const tbody = document.getElementById('bonusesTableBody');
    const emptyState = document.getElementById('emptyState');
    
    if (bonuses.length === 0) {
        tbody.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
    }
    
    emptyState.classList.add('hidden');
    
    tbody.innerHTML = bonuses.map(bonus => `
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-800">${bonus.employee_name || 'N/A'}</p>
                        <p class="text-xs text-gray-500">${bonus.employee_no || 'N/A'}</p>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 text-gray-600">
                ${formatDate(bonus.date)}
            </td>
            <td class="px-6 py-4">
                ${getBonusTypeBadge(bonus.bonus_type)}
            </td>
            <td class="px-6 py-4">
                <p class="font-bold text-green-600">${formatCurrency(bonus.amount)}</p>
            </td>
            <td class="px-6 py-4">
                <p class="text-sm text-gray-600 max-w-xs truncate" title="${bonus.reason || '-'}">${bonus.reason || '-'}</p>
            </td>
            <td class="px-6 py-4 text-gray-600 text-sm">
                ${bonus.given_by || 'Auto'}
            </td>
            <td class="px-6 py-4">
                ${bonus.bonus_type === 'manual' 
                    ? `<button onclick="deleteBonus('${bonus.id}')" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>`
                    : '<span class="text-gray-400">-</span>'
                }
            </td>
        </tr>
    `).join('');
}

function getBonusTypeBadge(type) {
    const badges = {
        perfect_attendance: '<span class="badge badge-success"><i class="fas fa-star mr-1"></i>Mukammal davomat</span>',
        early_arrival: '<span class="badge badge-info"><i class="fas fa-clock mr-1"></i>Erta kelish</span>',
        overtime: '<span class="badge badge-warning"><i class="fas fa-briefcase mr-1"></i>Qo\'shimcha ish</span>',
        manual: '<span class="badge badge-secondary"><i class="fas fa-hand-holding-usd mr-1"></i>Qo\'lda</span>'
    };
    return badges[type] || badges.manual;
}

function updateStats() {
    const total = bonuses.length;
    const totalAmount = bonuses.reduce((sum, b) => sum + b.amount, 0);
    
    const perfect = bonuses.filter(b => b.bonus_type === 'perfect_attendance');
    const perfectAmount = perfect.reduce((sum, b) => sum + b.amount, 0);
    
    const early = bonuses.filter(b => b.bonus_type === 'early_arrival');
    const earlyAmount = early.reduce((sum, b) => sum + b.amount, 0);
    
    const manual = bonuses.filter(b => b.bonus_type === 'manual');
    const manualAmount = manual.reduce((sum, b) => sum + b.amount, 0);
    
    document.getElementById('totalBonuses').textContent = total;
    document.getElementById('totalBonusAmount').textContent = formatCurrency(totalAmount);
    
    document.getElementById('perfectBonuses').textContent = perfect.length;
    document.getElementById('perfectBonusAmount').textContent = formatCurrency(perfectAmount);
    
    document.getElementById('earlyBonuses').textContent = early.length;
    document.getElementById('earlyBonusAmount').textContent = formatCurrency(earlyAmount);
    
    document.getElementById('manualBonuses').textContent = manual.length;
    document.getElementById('manualBonusAmount').textContent = formatCurrency(manualAmount);
    
    document.getElementById('totalCount').textContent = total;
    document.getElementById('showingCount').textContent = bonuses.length;
}

function renderPagination(pagination) {
    if (!pagination) return;
    
    const container = document.getElementById('paginationContainer');
    const pages = [];
    
    if (pagination.page > 1) {
        pages.push(`<button onclick="changePage(${pagination.page - 1})" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">
            <i class="fas fa-chevron-left"></i>
        </button>`);
    }
    
    for (let i = 1; i <= pagination.pages; i++) {
        if (i === pagination.page) {
            pages.push(`<button class="px-4 py-2 rounded-lg bg-blue-600 text-white font-medium">${i}</button>`);
        } else if (i === 1 || i === pagination.pages || (i >= pagination.page - 1 && i <= pagination.page + 1)) {
            pages.push(`<button onclick="changePage(${i})" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">${i}</button>`);
        } else if (i === pagination.page - 2 || i === pagination.page + 2) {
            pages.push(`<span class="px-2">...</span>`);
        }
    }
    
    if (pagination.page < pagination.pages) {
        pages.push(`<button onclick="changePage(${pagination.page + 1})" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">
            <i class="fas fa-chevron-right"></i>
        </button>`);
    }
    
    container.innerHTML = pages.join('');
}

function changePage(page) {
    currentPage = page;
    loadBonuses();
}

// Load leaderboard
async function loadLeaderboard() {
    showLoading();
    
    try {
        const startDate = document.getElementById('leaderboardStart').value;
        const endDate = document.getElementById('leaderboardEnd').value;
        
        const response = await API.bonuses.getLeaderboard({
            start_date: startDate,
            end_date: endDate,
            limit: 20
        });
        
        const leaderboard = response.leaderboard || [];
        
        if (leaderboard.length >= 3) {
            // Render top 3
            renderTopThree(leaderboard.slice(0, 3));
            // Render rest
            renderRestOfLeaderboard(leaderboard.slice(3));
        } else {
            renderRestOfLeaderboard(leaderboard);
        }
        
    } catch (error) {
        console.error('Error loading leaderboard:', error);
        showNotification('Liderlar ro\'yxatini yuklashda xatolik', 'error');
    } finally {
        hideLoading();
    }
}

function renderTopThree(top3) {
    const medals = ['ðŸ¥ˆ', 'ðŸ¥‡', 'ðŸ¥‰'];
    const colors = [
        'from-gray-400 to-gray-500',
        'from-yellow-400 to-yellow-500',
        'from-orange-400 to-orange-500'
    ];
    const sizes = ['text-4xl', 'text-5xl', 'text-4xl'];
    
    top3.forEach((item, idx) => {
        const actualIdx = idx === 0 ? 1 : idx === 1 ? 0 : 2; // Reorder for 2,1,3
        const container = document.getElementById(`rank${actualIdx + 1}`);
        
        container.innerHTML = `
            <div class="text-center">
                <div class="relative inline-block mb-4">
                    <div class="w-24 h-24 bg-gradient-to-br ${colors[actualIdx]} rounded-full flex items-center justify-center mx-auto shadow-lg">
                        <span class="${sizes[actualIdx]}">${medals[actualIdx]}</span>
                    </div>
                    <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 bg-white px-3 py-1 rounded-full shadow-md">
                        <span class="font-bold text-gray-800">#${actualIdx + 1}</span>
                    </div>
                </div>
                <h3 class="font-bold text-gray-800 text-lg mb-1">${item.full_name}</h3>
                <p class="text-sm text-gray-500 mb-3">${item.employee_no}</p>
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 border border-green-200">
                    <p class="text-2xl font-bold text-green-600 mb-1">${formatCurrency(item.total_amount)}</p>
                    <p class="text-xs text-gray-600">${item.bonus_count} ta bonus</p>
                </div>
            </div>
        `;
    });
}

function renderRestOfLeaderboard(rest) {
    const container = document.getElementById('leaderboardList');
    
    if (rest.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">Boshqa xodimlar yo\'q</p>';
        return;
    }
    
    container.innerHTML = rest.map((item, idx) => `
        <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md transition">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                    <span class="font-bold text-gray-600">${idx + 4}</span>
                </div>
                <div>
                    <p class="font-medium text-gray-800">${item.full_name}</p>
                    <p class="text-xs text-gray-500">${item.employee_no}</p>
                </div>
            </div>
            <div class="text-right">
                <p class="font-bold text-green-600">${formatCurrency(item.total_amount)}</p>
                <p class="text-xs text-gray-500">${item.bonus_count} ta bonus</p>
            </div>
        </div>
    `).join('');
}

// Modal functions
function openAddBonusModal() {
    document.getElementById('addBonusForm').reset();
    document.getElementById('bonusDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('addBonusModal').classList.remove('hidden');
}

function closeAddBonusModal() {
    document.getElementById('addBonusModal').classList.add('hidden');
}

function openPerfectAttendanceModal() {
    const now = new Date();
    document.getElementById('perfectMonth').value = now.getMonth() + 1;
    document.getElementById('perfectYear').value = now.getFullYear();
    document.getElementById('perfectAttendanceModal').classList.remove('hidden');
}

function closePerfectAttendanceModal() {
    document.getElementById('perfectAttendanceModal').classList.add('hidden');
}

function openEarlyArrivalModal() {
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
    document.getElementById('earlyStartDate').value = firstDay.toISOString().split('T')[0];
    document.getElementById('earlyEndDate').value = lastDay.toISOString().split('T')[0];
    
    document.getElementById('earlyArrivalModal').classList.remove('hidden');
}

function closeEarlyArrivalModal() {
    document.getElementById('earlyArrivalModal').classList.add('hidden');
}

// Form submissions
document.getElementById('addBonusForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const select = document.getElementById('bonusEmployeeId');
    const selectedOptions = Array.from(select.selectedOptions);
    const employeeIds = selectedOptions.map(opt => opt.value);
    
    if (employeeIds.length === 0) {
        showNotification('Kamida bitta xodim tanlang', 'warning');
        return;
    }
    
    const data = {
        employee_ids: employeeIds,
        bonus_type: 'manual',
        amount: parseFloat(document.getElementById('bonusAmount').value),
        date: document.getElementById('bonusDate').value,
        reason: document.getElementById('bonusReason').value
    };
    
    showLoading();
    
    try {
        await API.bonuses.bulkCreate(data);
        showNotification(`${employeeIds.length} ta xodimga bonus berildi`, 'success');
        closeAddBonusModal();
        loadBonuses();
    } catch (error) {
        console.error('Error creating bonus:', error);
        showNotification('Xatolik yuz berdi', 'error');
    } finally {
        hideLoading();
    }
});

document.getElementById('perfectAttendanceForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        month: parseInt(document.getElementById('perfectMonth').value),
        year: parseInt(document.getElementById('perfectYear').value),
        bonus_amount: parseFloat(document.getElementById('perfectAmount').value)
    };
    
    showLoading();
    
    try {
        const response = await API.bonuses.autoCalculatePerfectAttendance(data);
        showNotification(`${response.bonuses_created} ta xodimga bonus berildi`, 'success');
        closePerfectAttendanceModal();
        loadBonuses();
    } catch (error) {
        console.error('Error calculating perfect attendance:', error);
        showNotification(error.response?.data?.message || 'Xatolik yuz berdi', 'error');
    } finally {
        hideLoading();
    }
});

document.getElementById('earlyArrivalForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        start_date: document.getElementById('earlyStartDate').value,
        end_date: document.getElementById('earlyEndDate').value,
        early_minutes_threshold: parseInt(document.getElementById('earlyMinutes').value),
        min_early_days: parseInt(document.getElementById('earlyMinDays').value),
        bonus_amount: parseFloat(document.getElementById('earlyAmount').value)
    };
    
    showLoading();
    
    try {
        const response = await API.bonuses.autoCalculateEarlyArrival(data);
        showNotification(`${response.bonuses_created} ta xodimga bonus berildi`, 'success');
        closeEarlyArrivalModal();
        loadBonuses();
    } catch (error) {
        console.error('Error calculating early arrival:', error);
        showNotification(error.response?.data?.message || 'Xatolik yuz berdi', 'error');
    } finally {
        hideLoading();
    }
});

async function deleteBonus(bonusId) {
    if (!confirm('Bonusni o\'chirmoqchimisiz?')) return;
    
    showLoading();
    
    try {
        await API.bonuses.delete(bonusId);
        showNotification('Bonus o\'chirildi', 'success');
        loadBonuses();
    } catch (error) {
        console.error('Error deleting bonus:', error);
        showNotification('Xatolik yuz berdi', 'error');
    } finally {
        hideLoading();
    }
}

// Tab switching
function switchTab(tab) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tab + 'Tab').classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
    document.getElementById(tab + 'Content').classList.remove('hidden');
    
    if (tab === 'leaderboard') {
        loadLeaderboard();
    }
}

// Preview updates
document.getElementById('earlyMinDays').addEventListener('input', (e) => {
    document.getElementById('earlyMinDaysPreview').textContent = e.target.value;
});

document.getElementById('earlyMinutes').addEventListener('input', (e) => {
    document.getElementById('earlyMinutesPreview').textContent = e.target.value;
});

// Filters
document.getElementById('searchInput').addEventListener('input', debounce(() => {
    currentPage = 1;
    loadBonuses();
}, 500));

document.getElementById('startDate').addEventListener('change', () => {
    currentPage = 1;
    loadBonuses();
});

document.getElementById('endDate').addEventListener('change', () => {
    currentPage = 1;
    loadBonuses();
});

document.getElementById('bonusTypeFilter').addEventListener('change', () => {
    currentPage = 1;
    loadBonuses();
});

document.getElementById('employeeFilter').addEventListener('change', () => {
    currentPage = 1;
    loadBonuses();
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Set default date range (current month)
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
    document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
    document.getElementById('endDate').value = lastDay.toISOString().split('T')[0];
    
    document.getElementById('leaderboardStart').value = firstDay.toISOString().split('T')[0];
    document.getElementById('leaderboardEnd').value = lastDay.toISOString().split('T')[0];
    
    loadEmployees();
    loadBonuses();
});
</script>
{% endblock %}